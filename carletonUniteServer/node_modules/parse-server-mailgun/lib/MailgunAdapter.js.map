{"version":3,"sources":["../src/MailgunAdapter.js"],"names":["MailAdapter","require","mailgun","mailcomposer","_template","co","fs","path","ERRORS","missing_configuration","missing_mailgun_settings","bad_template_config","invalid_callback","invalid_template_name","MailgunAdapter","default","constructor","options","Error","apiKey","domain","fromAddress","templates","Object","keys","length","name","subject","pathPlainText","callback","cache","message","templateVars","selectedTemplate","_sendMail","templateName","template","config","direct","recipient","variables","from","to","link","appName","user","userVars","_validateUserVars","assign","username","get","email","_mailGenerator","bind","catch","e","console","error","compiled","pathHtml","cachedTemplate","plainTextEmail","_loadEmailTemplate","toString","interpolate","text","html","composer","mimeString","Promise","resolve","reject","build","payload","messages","sendMime","body","sendPasswordResetEmail","sendVerificationEmail","send","readFile","err","data","validUserVars","module","exports"],"mappings":"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","file":"MailgunAdapter.js","sourcesContent":["const MailAdapter = require('parse-server/lib/Adapters/Email/MailAdapter');\nconst mailgun = require('mailgun-js');\nconst mailcomposer = require('mailcomposer');\nconst _template = require('lodash.template');\nconst co = require('co');\nconst fs = require('fs');\nconst path = require('path');\n\nconst ERRORS = {\n    missing_configuration: 'MailgunAdapter requires configuration.',\n    missing_mailgun_settings: 'MailgunAdapter requires valid API Key, domain and fromAddress.',\n    bad_template_config: 'MailgunAdapter templates are not properly configured.',\n    invalid_callback: 'MailgunAdapter template callback is not a function.',\n    invalid_template_name: 'Invalid options object: missing templateName'\n};\n\n/**\n * MailAdapter implementation used by the Parse Server to send\n * password reset and email verification emails though Mailgun\n * @classnpm install --save-dev babel-preset-es2015-node\n */\nclass MailgunAdapter extends MailAdapter.default {\n    constructor(options) {\n        if (!options) {\n            throw new Error(ERRORS.missing_configuration);\n        }\n        \n        super(options);\n\n        const { apiKey, domain, fromAddress } = options;\n        if (!apiKey || !domain || !fromAddress) {\n            throw new Error(ERRORS.missing_mailgun_settings);\n        }\n\n        const { templates } = options;\n        if (!templates || Object.keys(templates).length === 0) {\n            throw new Error(ERRORS.bad_template_config);\n        }\n\n        for (let name in templates) {\n            const { subject, pathPlainText, callback } = templates[name];\n\n            if (typeof subject !== 'string' || typeof pathPlainText !== 'string') {\n                throw new Error(ERRORS.bad_template_config);\n            }\n\n            if (callback && typeof callback !== 'function') {\n                throw new Error(ERRORS.invalid_callback);\n            }\n        }\n\n        this.mailcomposer = mailcomposer;\n        this.mailgun = mailgun({ apiKey, domain });\n        this.fromAddress = fromAddress;\n        this.templates = templates;\n        this.cache = {};\n        this.message = {};\n        this.templateVars = {};\n        this.selectedTemplate = {};\n    }\n\n    /**\n     * Method to send MIME emails via Mailgun\n     * @param {Object} options\n     * @returns {Promise}\n     */\n    _sendMail(options) {\n        let templateName = this.selectedTemplate.name = options.templateName;\n        if (!templateName) {\n            throw new Error(ERRORS.invalid_template_name);\n        }\n\n        let template = this.selectedTemplate.config = this.templates[templateName];\n        if (!template) {\n            throw new Error(`Could not find template with name ${templateName}`);\n        }\n\n        // The adapter is used directly by the user's code instead via Parse Server\n        if (options.direct) {\n            const { subject, fromAddress, recipient, variables } = options;\n            \n            if (!recipient) {\n                throw new Error(`Cannot send email with template ${templateName} without a recipient`);\n            }\n\n            this.templateVars = variables || {};\n            this.message = {\n                from: fromAddress || this.fromAddress,\n                to: recipient,\n                subject: subject || template.subject\n            };\n        } else {\n            const { link, appName, user } = options;\n            const { callback } = template;\n            \n            let userVars;\n            if (callback && typeof callback === 'function') {\n                userVars = callback(user);\n                userVars = this._validateUserVars(userVars);\n            }\n\n            this.templateVars = Object.assign({\n                link,\n                appName,\n                username: user.get('username'),\n                email: user.get('email')\n            }, userVars);\n\n            this.message = {\n                from: this.fromAddress,\n                to: user.get('email'),\n                subject: template.subject\n            };\n        }\n\n        return co(this._mailGenerator.bind(this)).catch(e => console.error(e));\n    }\n\n    /**\n     * Generator function that handles that handles all the async operations:\n     * template loading, MIME string building and email sending.\n     */\n    *_mailGenerator() {\n        let compiled;\n        let template = this.selectedTemplate.config;\n        let templateName = this.selectedTemplate.name;\n        let pathPlainText = template.pathPlainText;\n        let pathHtml = template.pathHtml;\n        let cachedTemplate = this.cache[templateName] = this.cache[templateName] || {};\n\n        // Load plain-text version\n        if (!cachedTemplate['text']) {\n            let plainTextEmail = yield this._loadEmailTemplate(pathPlainText);\n            plainTextEmail = plainTextEmail.toString('utf8');\n            cachedTemplate['text'] = plainTextEmail;\n        }\n\n        // Compile plain-text template\n        compiled = _template(cachedTemplate['text'], { interpolate: /{{([\\s\\S]+?)}}/g});\n        // Add processed text to the message object\n        this.message.text = compiled(this.templateVars);\n\n        // Load html version if available\n        if (pathHtml) {\n            if (!cachedTemplate['html']) {\n                cachedTemplate['html'] = yield this._loadEmailTemplate(pathHtml);\n            }\n\n            // Compile html template\n            compiled = _template(cachedTemplate['html'], { interpolate: /{{([\\s\\S]+?)}}/g});\n            // Add processed HTML to the message object\n            this.message.html = compiled(this.templateVars);\n        }\n\n        // Initialize mailcomposer with message\n        const composer = this.mailcomposer(this.message);\n\n        // Create MIME string\n        const mimeString = yield new Promise((resolve, reject) => {\n            composer.build((error, message) => {\n                if (error) reject(error);\n                resolve(message);\n            });\n        });\n\n        // Assemble payload object for Mailgun\n        const payload = {\n            to: this.message.to,\n            message: mimeString.toString('utf8')\n        };\n\n        return new Promise((resolve, reject) => {\n            this.mailgun.messages().sendMime(payload, (error, body) => {\n                if (error) reject(error);\n                resolve(body);\n            });\n        });\n    }\n\n    /**\n     * sendMail wrapper to send an email with password reset link\n     * The options object would have the parameters link, appName, user\n     * @param {Object} options\n     * @returns {Promise}\n     */\n    sendPasswordResetEmail({ link, appName, user }) {\n        return this._sendMail({ templateName: 'passwordResetEmail', link, appName, user });\n    }\n\n    /**\n     * sendMail wrapper to send an email with an account verification link\n     * The options object would have the parameters link, appName, user\n     * @param {Object} options\n     * @returns {Promise}\n     */\n    sendVerificationEmail({ link, appName, user }) {\n        return this._sendMail({ templateName: 'verificationEmail', link, appName, user });\n    }\n\n    /**\n     * sendMail wrapper to send general purpose emails\n     * The options object would have the parameters:\n     * - templateName: name of template to be used\n     * - subject: overrides the default value\n     * - fromAddress: overrides the default from address\n     * - recipient: email's recipient\n     * - variables: An object whose property names represent template variables,\n     *              and whose values will replace the template variable placeholders\n     * @param {Object} options\n     * @returns {Promise}\n     */\n    send({ templateName, subject, fromAddress, recipient, variables }) {\n        return this._sendMail({ templateName, subject, fromAddress, recipient, variables, direct: true });\n    }\n\n    /**\n     * Simple Promise wrapper to asynchronously fetch the contents of a template.\n     * @param {String} path\n     * @returns {Promise}\n     */\n    _loadEmailTemplate(path) {\n        return new Promise((resolve, reject) => {\n            fs.readFile(path, (err, data) => {\n                if (err) reject(err);\n                resolve(data);\n            });\n        });\n    }\n\n    /**\n     * Validator for user provided template variables\n     * @param {Object} userVars\n     * @returns {Object}\n     */\n    _validateUserVars(userVars) {\n        const validUserVars = userVars && userVars.constructor === Object;\n        // Fall back to an empty object if the callback did not return an Object instance\n        return validUserVars ? userVars : {};\n    }\n}\n\nmodule.exports = MailgunAdapter;"]}